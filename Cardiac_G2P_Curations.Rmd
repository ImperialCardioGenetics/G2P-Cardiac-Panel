---
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: lumen
    keep_md: true
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(readxl)
library(kableExtra)
```


<h1 style="font-size: 50px">Cardiac G2P curations</h1>

<p style=\"page-break-before: always;\">&nbsp;</p>

```{r convert_xlsx_to_csv, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# read excel supp file
g2p_formated <- read_excel("CardiacG2P.xlsx",sheet = 1,col_types = "text")
g2p_narrative <- read_excel("CardiacG2P.xlsx",sheet = 2,col_types = "text") %>%
  select("Narrative"=`Narrative...3`) %>%
  mutate(across(c("Narrative"), ~ str_replace_all(.,"<br/>","\n")))

g2p <- g2p_formated %>%
  cbind(g2p_narrative)

# write csv
write_csv(g2p,"CardiacG2P.csv",quote = "all" )

```

```{r read_g2p, message=FALSE, warning=FALSE, include=FALSE}

g2p <- read_csv("CardiacG2P.csv", col_types = cols(.default = col_character()))

# get arrhythmia genes for chapter change
arri_genes <- g2p %>% filter(!str_detect(.$`Referral indication`,c("ARVC|DCM|HCM"))) %>% pull(Gene)

chapter1 <- "INHERITED ARRHYTHMIA SYNDROMES"
chapter2 <- "CARDIOMYOPATHY"


```


```{r render_tables, echo=FALSE, results='asis'}

ref_ind <- g2p[1, 3]


cat(paste0("<h2>",chapter1,"</h2>"))
cat(paste0("<h3>",ref_ind,"</h3>"))


for (i in 1:nrow(g2p)){
  
  gene <- g2p[i,] %>% pivot_longer(everything()) %>% set_names(slice(.,1)) %>% slice(.,-1) %>% tibble() %>% slice_head(n=-1)
  
  if (i==(length(arri_genes)+1)) {
    cat(paste0("<h2>",chapter2,"</h2>"))
  }
  
  
  if ((g2p[i, 3]) != ref_ind) {
    cat(paste0("<h3>",g2p[i, 3],"</h3>"))
    ref_ind <- g2p[i, 3]
  }
      
  # print gene text
  print(
    kbl(gene, 
        full_width = T,
        booktabs = TRUE
        )%>%
    kable_styling(font_size =12,
                  html_font = "sans-serif",
                  bootstrap_options = c("striped", "condensed", "scale_down"))%>% 
      column_spec(1, width = "6cm") %>% 
      row_spec(0, bold = TRUE,font_size =14) %>% 
      row_spec(4, bold = TRUE)
  
  )
  
  # Add a new line before the narrative free text so the md format of the first paragraph is rendered correctly 
  narrative <- g2p[i,ncol(g2p)] %>% 
    tibble() %>%  set_names("Narrative") %>% transmute(Narrative = paste0("<br /> \n\n",Narrative))

  # print narrative text
  print(
    kbl(narrative,escape = F,
        full_width = T,
        booktabs = TRUE
        ) %>%
    kable_styling(font_size =12,
                  html_font = "sans-serif",
                bootstrap_options = c("striped", "condensed")) %>% 
      row_spec(0, bold = TRUE,font_size =14)
  
  )
  
  # Add page breaks after every gene to be rendered by md and html
  cat("\n")
  cat("<br>")
  cat("\n")
  cat("<p style=\"page-break-before: always;\">&nbsp;</p>")

   
}
```

```{r session_info, message=FALSE, warning=FALSE, include=FALSE}

sessionInfo()

```

